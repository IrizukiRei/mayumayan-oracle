<!-- DEPLOY TEST 2025-12-25 19:35 -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¹­ç¹­åºµ ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Hiragino Mincho ProN', 'Yu Mincho', 'YuMincho', serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 15px;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-shadow: 0 0 10px rgba(100,200,255,0.5);
            letter-spacing: 0.2em;
            font-weight: 300;
        }
        
        @media (min-width: 768px) {
            h1 {
                font-size: 2.2em;
                letter-spacing: 0.3em;
            }
        }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav-tabs button {
            padding: 10px 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: #fff;
            cursor: pointer;
            border-radius: 8px;
            font-size: 12px;
            transition: all 0.3s;
            flex: 1;
            min-width: 60px;
            max-width: 120px;
        }
        
        @media (min-width: 768px) {
            .nav-tabs button {
                padding: 12px 24px;
                font-size: 16px;
                max-width: none;
            }
        }
        
        .nav-tabs button:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .nav-tabs button.active {
            background: rgba(100,200,255,0.3);
            border-color: rgba(100,200,255,0.8);
        }
        
        .screen {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (min-width: 768px) {
            .card-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
        }
        
        .card-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .card-preview {
            width: 100%;
            aspect-ratio: 2/3;
            background: #2a2a4a;
            border-radius: 4px;
            margin-bottom: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #888;
        }
        
        .card-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .card-item input[type="text"],
        .card-item textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 14px;
        }
        
        .card-item textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .upload-btn {
            width: 100%;
            padding: 10px;
            background: rgba(100,200,255,0.2);
            border: 1px solid rgba(100,200,255,0.5);
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .upload-btn:active {
            background: rgba(100,200,255,0.4);
        }
        
        /* ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰é¸æŠ */
        .spread-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        
        @media (min-width: 768px) {
            .spread-selection {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }
        }
        
        .spread-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .spread-card:active {
            background: rgba(255,255,255,0.2);
            border-color: rgba(100,200,255,0.8);
        }
        
        .spread-card h3 {
            margin-bottom: 8px;
            color: #64c8ff;
            font-size: 1em;
        }
        
        .spread-card p {
            font-size: 12px;
            line-height: 1.4;
        }
        
        /* ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .spread-display {
            position: relative;
            min-height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            background: rgba(0,0,0,0.3);
            border: 3px solid rgba(100,200,255,0.5);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(100,200,255,0.3);
            overflow-x: auto;
        }
        
        .spread-inner {
            position: relative;
            min-width: 550px;
            min-height: 300px;
        }
        
        .card-slot {
            width: 70px;
            height: 105px;
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 6px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            perspective: 1000px;
            transform: translate(-50%, -50%);
        }
        
        @media (min-width: 768px) {
            .card-slot {
                width: 100px;
                height: 150px;
                font-size: 12px;
            }
            
            .spread-inner {
                min-width: 700px;
                min-height: 450px;
            }
        }
        
        .card-slot.filled {
            border: 2px solid rgba(100,200,255,0.8);
            background: transparent;
        }
        
        /* ãƒœã‚¿ãƒ³ */
        .controls {
            text-align: center;
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 20px;
            background: rgba(100,200,255,0.2);
            border: 2px solid rgba(100,200,255,0.5);
            color: #fff;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            letter-spacing: 0.1em;
        }
        
        .btn:active {
            background: rgba(100,200,255,0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ */
        .deck-info {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }
        
        .error-message {
            background: rgba(220,53,69,0.3);
            border: 2px solid #dc3545;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .card-number {
            font-size: 10px;
            color: #888;
            margin-bottom: 5px;
        }
        
        .add-cards-section {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .add-cards-section input {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.3);
            color: #fff;
            width: 80px;
        }

        .back-card-section {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .back-preview {
            width: 60px;
            height: 90px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #fff;
            flex-shrink: 0;
        }

        .back-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .result-info h3 {
            color: #64c8ff;
            margin-bottom: 12px;
            font-size: 1em;
        }

        .card-meaning {
            margin: 8px 0;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            font-size: 14px;
        }

        .card-meaning strong {
            color: #64c8ff;
        }

        .info-box {
            background: rgba(100,200,255,0.1);
            border: 2px solid rgba(100,200,255,0.3);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .info-box h3 {
            color: #64c8ff;
            margin-bottom: 8px;
            font-size: 1em;
        }

        /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .shuffle-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 120px;
            perspective: 1000px;
        }
        
        .shuffle-card {
            position: absolute;
            width: 70px;
            height: 105px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }
        
        .shuffle-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        
        @keyframes shuffleSpread {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(var(--tx), var(--ty)) rotate(var(--rot)); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        
        @keyframes shuffleRiffle {
            0%, 100% { transform: translateY(0) rotateX(0); }
            25% { transform: translateY(-30px) rotateX(-15deg); }
            75% { transform: translateY(-15px) rotateX(10deg); }
        }
        
        @keyframes cardFlyOut {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--fly-x), var(--fly-y)) scale(0.8); opacity: 0; }
        }
        
        .shuffling .shuffle-card {
            animation: shuffleRiffle 0.4s ease-in-out infinite;
            animation-delay: var(--delay);
        }
        
        .spreading .shuffle-card {
            animation: shuffleSpread 0.6s ease-out forwards;
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒ•ãƒªãƒƒãƒ— */
        .card-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        
        .card-inner.flipped {
            transform: rotateY(180deg);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .card-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .card-back img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .card-front {
            transform: rotateY(180deg);
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .card-front img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .card-front.reversed img,
        .card-front.reversed .card-text {
            transform: rotate(180deg);
        }
        
        .card-text {
            padding: 5px;
            color: #333;
            font-size: 10px;
            text-align: center;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-image {
            max-width: 90%;
            max-height: 85%;
            object-fit: contain;
        }
        
        .modal-image.reversed {
            transform: rotate(180deg);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 40px;
            color: white;
            cursor: pointer;
            z-index: 10000;
        }

        /* å„€å¼ç”»é¢ */
        .ritual-container {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            max-width: 800px;
            margin: 0 auto;
        }

        .ritual-section {
            margin-bottom: 30px;
        }

        .ritual-section h3 {
            color: #64c8ff;
            margin-bottom: 12px;
            font-size: 1em;
        }

        .ritual-section p {
            line-height: 1.8;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .question-list {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .question-list li {
            list-style: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
        }

        .question-list li:active {
            background: rgba(100,200,255,0.2);
        }

        textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(100,200,255,0.3);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 14px;
            min-height: 80px;
            font-family: inherit;
        }

        .crystal-item {
            background: rgba(100,200,255,0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #64c8ff;
        }

        .crystal-date {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
        .title-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0f14 0%, #1a1f2e 50%, #0f1a20 100%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .title-screen.hidden {
            display: none;
        }

        /* èƒŒæ™¯ã®èœ˜è››ã®å·£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .web-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.15;
            background-image: 
                radial-gradient(circle at 50% 50%, transparent 0%, transparent 40%, rgba(100,200,255,0.1) 41%, transparent 42%),
                radial-gradient(circle at 50% 50%, transparent 0%, transparent 60%, rgba(100,200,255,0.08) 61%, transparent 62%),
                radial-gradient(circle at 50% 50%, transparent 0%, transparent 80%, rgba(100,200,255,0.05) 81%, transparent 82%);
            background-size: 100% 100%;
            animation: webPulse 8s ease-in-out infinite;
        }

        .web-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(0deg, transparent 49.5%, rgba(100,200,255,0.1) 50%, transparent 50.5%),
                linear-gradient(60deg, transparent 49.5%, rgba(100,200,255,0.1) 50%, transparent 50.5%),
                linear-gradient(120deg, transparent 49.5%, rgba(100,200,255,0.1) 50%, transparent 50.5%);
            background-size: 100% 100%;
        }

        @keyframes webPulse {
            0%, 100% { transform: scale(1); opacity: 0.15; }
            50% { transform: scale(1.05); opacity: 0.25; }
        }

        /* æµ®éŠã™ã‚‹çµæ™¶ */
        .floating-crystal {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, rgba(100,200,255,0.6), rgba(180,100,255,0.6));
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            animation: floatCrystal 6s ease-in-out infinite;
            filter: blur(1px);
        }

        @keyframes floatCrystal {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.6; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }

        /* ãƒ¡ã‚¤ãƒ³ç¹­ã‚¢ã‚¤ã‚³ãƒ³ */
        .cocoon-icon {
            width: 120px;
            height: 160px;
            position: relative;
            margin-bottom: 30px;
            animation: cocoonFloat 4s ease-in-out infinite;
        }

        .cocoon-body {
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at 50% 30%, #fff 0%, #e8e8f0 40%, #c0c0d0 100%);
            border-radius: 50% 50% 45% 45%;
            position: relative;
            box-shadow: 
                0 0 30px rgba(100,200,255,0.3),
                0 0 60px rgba(100,200,255,0.2),
                inset 0 -20px 40px rgba(100,150,200,0.2);
        }

        .cocoon-body::before {
            content: 'ğŸŒ¿';
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
        }

        @keyframes cocoonFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ãƒ†ã‚­ã‚¹ãƒˆ */
        .title-text {
            font-size: 2.5em;
            letter-spacing: 0.4em;
            color: #fff;
            text-shadow: 
                0 0 10px rgba(100,200,255,0.8),
                0 0 20px rgba(100,200,255,0.5),
                0 0 40px rgba(100,200,255,0.3);
            margin-bottom: 10px;
            animation: titleGlow 3s ease-in-out infinite;
        }

        .title-sub {
            font-size: 1em;
            letter-spacing: 0.3em;
            color: rgba(200,220,255,0.7);
            margin-bottom: 40px;
        }

        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 10px rgba(100,200,255,0.8), 0 0 20px rgba(100,200,255,0.5); }
            50% { text-shadow: 0 0 20px rgba(100,200,255,1), 0 0 40px rgba(100,200,255,0.8), 0 0 60px rgba(180,100,255,0.5); }
        }

        .start-btn {
            padding: 15px 50px;
            background: transparent;
            border: 2px solid rgba(100,200,255,0.5);
            color: #fff;
            font-size: 1.1em;
            letter-spacing: 0.2em;
            cursor: pointer;
            border-radius: 30px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .start-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(100,200,255,0.3), transparent);
            transition: left 0.5s;
        }

        .start-btn:hover::before {
            left: 100%;
        }

        .start-btn:hover {
            background: rgba(100,200,255,0.2);
            box-shadow: 0 0 20px rgba(100,200,255,0.5);
        }

        /* è¶ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .butterfly {
            position: absolute;
            font-size: 20px;
            opacity: 0.6;
            animation: butterflyFly 15s linear infinite;
        }

        @keyframes butterflyFly {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(100px, -50px) rotate(10deg); }
            50% { transform: translate(50px, -100px) rotate(-5deg); }
            75% { transform: translate(-50px, -30px) rotate(5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* ã‚»ãƒƒãƒˆç®¡ç† */
        .sets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .set-input {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.3);
            color: #fff;
            width: 100%;
            max-width: 250px;
            margin-bottom: 10px;
        }

        /* ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è­¦å‘Š */
        .storage-warning {
            background: rgba(255,193,7,0.2);
            border: 2px solid #ffc107;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .storage-info {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
    <div class="title-screen" id="titleScreen">
        <div class="web-bg"></div>
        
        <!-- æµ®éŠã™ã‚‹çµæ™¶ -->
        <div class="floating-crystal" style="top:15%;left:20%;animation-delay:0s;"></div>
        <div class="floating-crystal" style="top:25%;left:75%;animation-delay:1s;width:15px;height:15px;"></div>
        <div class="floating-crystal" style="top:60%;left:15%;animation-delay:2s;width:25px;height:25px;"></div>
        <div class="floating-crystal" style="top:70%;left:80%;animation-delay:3s;"></div>
        <div class="floating-crystal" style="top:40%;left:85%;animation-delay:1.5s;width:12px;height:12px;"></div>
        
        <!-- è¶ -->
        <div class="butterfly" style="top:30%;left:30%;animation-delay:0s;">ğŸ¦‹</div>
        <div class="butterfly" style="top:50%;left:60%;animation-delay:5s;font-size:16px;">ğŸ¦‹</div>
        
        <!-- ç¹­ã‚¢ã‚¤ã‚³ãƒ³ -->
        <div class="cocoon-icon">
            <div class="cocoon-body"></div>
        </div>
        
        <div class="title-text">ç¹­ç¹­åºµ</div>
        <div class="title-sub">ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰</div>
        
        <button class="start-btn" id="startBtn">ã¯ã˜ã‚ã‚‹</button>
    </div>

    <div class="container">
        <h1>ç¹­ç¹­åºµ ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰</h1>
        
        <div class="nav-tabs">
            <button class="active" onclick="showScreen('edit')">ç·¨é›†</button>
            <button onclick="showScreen('sets')">ã‚»ãƒƒãƒˆ</button>
            <button onclick="showScreen('spread')">å±•é–‹</button>
            <button onclick="showScreen('reading')">å ã†</button>
            <button onclick="showScreen('ritual')">å„€å¼</button>
        </div>

        <!-- ã‚«ãƒ¼ãƒ‰ç·¨é›†ç”»é¢ -->
        <div id="edit-screen" class="screen active">
            <div class="info-box">
                <h3>ğŸ“± ã‚¹ãƒãƒ›å¯¾å¿œç‰ˆ</h3>
                <p>ç”»åƒã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«ã«æ®‹ã‚Šã¾ã™ã€‚</p>
            </div>

            <div class="info-box" style="background:rgba(255,200,100,0.1);border-color:rgba(255,200,100,0.3);">
                <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</h3>
                <p style="margin-bottom:10px;">PCâ†”ã‚¹ãƒãƒ›é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç§»ã™ã«ã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn" onclick="exportData()" style="padding:10px 15px;font-size:13px;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <input type="file" accept=".json" style="display:none" id="import-file" onchange="importData(this)">
                    <button class="btn" onclick="document.getElementById('import-file').click()" style="padding:10px 15px;font-size:13px;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>

            <div id="storage-warning" class="storage-warning" style="display:none;">
                âš ï¸ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ãŒå¤šããªã£ã¦ã„ã¾ã™ã€‚ç”»åƒã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ã‹ã€ä¸è¦ãªã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
            </div>

            <div class="deck-info">
                <p>ã‚«ãƒ¼ãƒ‰: <span id="master-count">0</span>æš / æœ‰åŠ¹: <span id="active-count">0</span>æš</p>
                <div class="storage-info" id="storage-info"></div>
            </div>

            <div class="back-card-section">
                <div>
                    <div style="font-size:12px;margin-bottom:5px;">è£é¢</div>
                    <div class="back-preview" id="back-preview">ğŸ”®</div>
                </div>
                <div style="flex:1;">
                    <input type="file" accept="image/*" style="display:none" 
                           id="back-file" onchange="selectBackImage(this)">
                    <button class="btn" onclick="document.getElementById('back-file').click()">
                        è£é¢ç”»åƒ
                    </button>
                </div>
            </div>

            <div class="back-card-section">
                <div>
                    <div style="font-size:12px;margin-bottom:5px;">ã‚·ã‚°ãƒ‹ãƒ•ã‚£ã‚±ãƒ¼ã‚¿ãƒ¼</div>
                    <div class="back-preview" id="sig-preview" style="background:rgba(255,200,100,0.3);">æœªè¨­å®š</div>
                </div>
                <div style="flex:1;">
                    <button class="btn" onclick="openSignificatorSelect()" style="font-size:13px;">
                        ã‚«ãƒ¼ãƒ‰é¸æŠ
                    </button>
                    <button class="btn" onclick="clearSignificator()" style="font-size:13px;background:rgba(220,53,69,0.3);border-color:#dc3545;">
                        è§£é™¤
                    </button>
                    <div style="font-size:11px;color:#888;margin-top:5px;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã§ã€Œç§ã€ã‚’ç¤ºã™åŸºæº–æœ­</div>
                </div>
            </div>
            
            <div class="add-cards-section">
                <label style="font-size:14px;">æšæ•°:</label>
                <input type="number" id="card-count-input" min="1" max="150" value="59">
                <button class="btn" onclick="setCardCount()">è¨­å®š</button>
            </div>
            
            <div id="card-grid" class="card-grid"></div>
        </div>

        <!-- ã‚»ãƒƒãƒˆç®¡ç†ç”»é¢ -->
        <div id="sets-screen" class="screen">
            <div class="info-box">
                <h3>ğŸ“¦ ã‚»ãƒƒãƒˆç®¡ç†</h3>
                <p>è¤‡æ•°ã®ã‚«ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã¦ä½¿ç”¨ã§ãã¾ã™</p>
            </div>

            <div class="deck-info">
                <p>ç¾åœ¨: <strong id="current-set-name">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</strong></p>
            </div>

            <div style="margin-bottom:15px;">
                <input type="text" id="new-set-name" placeholder="æ–°ã—ã„ã‚»ãƒƒãƒˆå" class="set-input">
                <button class="btn" onclick="createNewSet()">ä½œæˆ</button>
            </div>

            <div id="sets-list" class="sets-grid"></div>
        </div>

        <!-- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰é¸æŠç”»é¢ -->
        <div id="spread-screen" class="screen">
            <div class="deck-info">
                <p>æœ‰åŠ¹ã‚«ãƒ¼ãƒ‰: <span id="spread-active-count">0</span>æš</p>
            </div>

            <div class="info-box" id="sig-toggle-box" style="display:none;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="use-sig-toggle" onchange="toggleSignificator()" style="width:20px;height:20px;">
                    <span>ã‚·ã‚°ãƒ‹ãƒ•ã‚£ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨</span>
                    <span id="sig-name-display" style="color:#64c8ff;font-size:12px;"></span>
                </label>
                <div style="font-size:11px;color:#888;margin-top:5px;">
                    å›ºå®šé…ç½®ç³»: æ‰€å®šä½ç½®ã«å›ºå®š / ã‚°ãƒ©ãƒ³ã‚¿ãƒ–ãƒ­ãƒ¼: å‡ºãŸä½ç½®ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                </div>
            </div>

            <div class="info-box">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="use-reversal-toggle" onchange="toggleReversal()" checked style="width:20px;height:20px;">
                    <span>æ­£é€†ã‚’å–ã‚‹</span>
                </label>
                <div style="font-size:11px;color:#888;margin-top:5px;">
                    OFFã«ã™ã‚‹ã¨ã‚«ãƒ¼ãƒ‰ã¯å¸¸ã«æ­£ä½ç½®ã§å‡ºã¾ã™ï¼ˆã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰å‘ã‘ï¼‰
                </div>
            </div>
            
            <div id="error-container"></div>
            
            <h2 style="margin:15px 0;font-size:1em;">ã‚¿ãƒ­ãƒƒãƒˆç³»</h2>
            <div class="spread-selection">
                <div class="spread-card" onclick="selectSpread('one', 1)">
                    <h3>ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«</h3>
                    <p>1æš / ã‚·ãƒ³ãƒ—ãƒ«</p>
                </div>
                <div class="spread-card" onclick="selectSpread('two', 2)">
                    <h3>ãƒ„ãƒ¼ã‚«ãƒ¼ãƒ‰</h3>
                    <p>2æš / äºŒæŠ</p>
                </div>
                <div class="spread-card" onclick="selectSpread('three', 3)">
                    <h3>ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰</h3>
                    <p>3æš / éå»ç¾åœ¨æœªæ¥</p>
                </div>
                <div class="spread-card" onclick="selectSpread('hexagram', 6)">
                    <h3>ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ </h3>
                    <p>6æš / å¤šè§’çš„åˆ†æ</p>
                </div>
                <div class="spread-card" onclick="selectSpread('celtic', 10)">
                    <h3>ã‚±ãƒ«ãƒˆåå­—</h3>
                    <p>10æš / è©³ç´°åˆ†æ</p>
                </div>
            </div>
            
            <h2 style="margin:15px 0;font-size:1em;">ç¹­ç¹­åºµã‚ªãƒªã‚¸ãƒŠãƒ«</h2>
            <div class="spread-selection">
                <div class="spread-card" onclick="selectSpread('neutralize', 5)">
                    <h3>ä¸­ç«‹åŒ–å¼•ã</h3>
                    <p>5æš / ç¾çŠ¶â†’åˆºæ¿€â†’é€ƒé¿â†’å­¤ç«‹â†’çµæ™¶</p>
                </div>
                <div class="spread-card" onclick="selectSpread('circle', 9)">
                    <h3>å††ç’°ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰</h3>
                    <p>8+1æš / 8å±æ€§ï¼‹ä¸­å¤®ã«ğŸ’</p>
                </div>
            </div>
            
            <h2 style="margin:15px 0;font-size:1em;">ãƒ«ãƒãƒ«ãƒãƒ³ç³»</h2>
            <div class="spread-selection">
                <div class="spread-card" onclick="selectSpread('nine', 9)">
                    <h3>ãƒŠã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰</h3>
                    <p>9æš / 3Ã—3</p>
                </div>
                <div class="spread-card" onclick="selectSpread('grand', 36)">
                    <h3>ã‚°ãƒ©ãƒ³ã‚¿ãƒ–ãƒ­ãƒ¼</h3>
                    <p>36æš / å¤§å±•é–‹</p>
                </div>
            </div>
        </div>

        <!-- ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
        <div id="reading-screen" class="screen">
            <div class="controls">
                <button class="btn" onclick="shuffleAndDraw()">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
                <button class="btn" onclick="skipShuffle()">ã‚¹ã‚­ãƒƒãƒ—</button>
                <button class="btn" onclick="resetReading()">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <div id="spread-display" class="spread-display">
                <div id="spread-inner" class="spread-inner"></div>
            </div>
            
            <div id="result-info" class="result-info" style="display:none;"></div>
        </div>

        <!-- å„€å¼ç”»é¢ -->
        <div id="ritual-screen" class="screen">
            <div class="ritual-container">
                <div class="ritual-section">
                    <h3>1. ä¸­ç«‹åŒ–ã®æº–å‚™</h3>
                    <p>æ·±å‘¼å¸ã‚’3å›ã€‚å¸ã†æ¯ã§æ„Ÿæƒ…ã‚’è¦³å¯Ÿã—ã€åãæ¯ã§å–„æ‚ªã®åˆ¤æ–­ã‚’æ‰‹æ”¾ã—ã¾ã™ã€‚</p>
                    <button class="btn" onclick="startBreathing()" id="breathBtn">æ·±å‘¼å¸ã‚’å§‹ã‚ã‚‹</button>
                    <div id="breathTimer" style="margin-top:12px;font-size:1.2em;color:#64c8ff;"></div>
                </div>

                <div class="ritual-section">
                    <h3>2. å•ã„ã‚’ç«‹ã¦ã‚‹</h3>
                    <div class="question-list">
                        <p style="color:#888;font-size:12px;margin-bottom:8px;">ä¾‹:</p>
                        <ul style="padding:0;">
                            <li onclick="setQuestion(this.textContent)">ä»Šã®ç§ã«å¿…è¦ãªé€ƒé¿ã®é‡ã¯?</li>
                            <li onclick="setQuestion(this.textContent)">ä»Šã®ç§ã«å¿…è¦ãªåˆºæ¿€ã®é‡ã¯?</li>
                            <li onclick="setQuestion(this.textContent)">ä»Šã®ç§ã«å¿…è¦ãªå­¤ç«‹ã®é‡ã¯?</li>
                            <li onclick="setQuestion(this.textContent)">ã“ã®æ„Ÿæƒ…ã‚’ã©ã†æ•´ãˆã‚Œã°ã„ã„?</li>
                            <li onclick="setQuestion(this.textContent)">ã“ã®é–¢ä¿‚ã®æ¸©åº¦ã¯ä»Šã©ã“ã«ã‚ã‚‹?</li>
                        </ul>
                    </div>
                    <textarea id="questionInput" placeholder="å•ã„ã‚’å…¥åŠ›..."></textarea>
                </div>

                <div class="ritual-section">
                    <h3>3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚’é¸ã¶</h3>
                    <button class="btn" onclick="goToSpread()">å±•é–‹ç”»é¢ã¸</button>
                </div>

                <div class="ritual-section">
                    <h3>4. çµæ™¶åŒ–</h3>
                    <p>ã‚«ãƒ¼ãƒ‰ã‹ã‚‰å—ã‘å–ã£ãŸè¨€è‘‰ã‚’1ã¤ã ã‘æ›¸ãç•™ã‚ã¾ã™ã€‚</p>
                    <textarea id="crystalNote" placeholder="çµæ™¶ã¨ã—ã¦æ®‹ã™è¨€è‘‰..."></textarea>
                    <button class="btn" onclick="saveCrystal()" style="margin-top:10px;">ä¿å­˜</button>
                    
                    <div style="margin-top:20px;">
                        <h4 style="color:#64c8ff;margin-bottom:10px;font-size:0.9em;">éå»ã®çµæ™¶</h4>
                        <div id="crystalList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="imageModal" onclick="closeImageModal()">
        <div class="modal-close">&times;</div>
        <img class="modal-image" id="modalImage" src="">
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let masterCards = [];
        let cardSets = {};
        let currentSetName = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ';
        let currentSpread = null;
        let currentSpreadSize = 0;
        let drawnCards = [];
        let backCardImage = '';
        let significatorId = null; // ã‚·ã‚°ãƒ‹ãƒ•ã‚£ã‚±ãƒ¼ã‚¿ãƒ¼
        let useSignificator = false; // ã‚·ã‚°ãƒ‹ãƒ•ã‚£ã‚±ãƒ¼ã‚¿ãƒ¼ä½¿ç”¨ãƒ•ãƒ©ã‚°
        let useReversal = true; // æ­£é€†ã‚’å–ã‚‹ã‹ã©ã†ã‹
        let useReversal = true; // æ­£é€†ã‚’ä½¿ç”¨ã™ã‚‹ã‹
        
        // åˆæœŸåŒ–
        function init() {
            const savedMaster = localStorage.getItem('oracleCards');
            if (savedMaster) {
                masterCards = JSON.parse(savedMaster);
            } else {
                for (let i = 0; i < 59; i++) {
                    masterCards.push({
                        id: i,
                        name: `ã‚«ãƒ¼ãƒ‰ ${i + 1}`,
                        description: '',
                        imageData: ''
                    });
                }
                saveMasterCards();
            }

            const savedSets = localStorage.getItem('oracleSets');
            if (savedSets) {
                cardSets = JSON.parse(savedSets);
            } else {
                cardSets = {'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ': masterCards.map(c => c.id)};
                saveSets();
            }

            const savedCurrentSet = localStorage.getItem('oracleCurrentSet');
            if (savedCurrentSet && cardSets[savedCurrentSet]) {
                currentSetName = savedCurrentSet;
            }
            
            const savedBack = localStorage.getItem('oracleBackImage');
            if (savedBack) {
                backCardImage = savedBack;
                updateBackPreview();
            }
            
            const savedSig = localStorage.getItem('oracleSignificator');
            if (savedSig !== null) {
                significatorId = parseInt(savedSig);
            }
            
            const savedReversal = localStorage.getItem('oracleUseReversal');
            if (savedReversal !== null) {
                useReversal = savedReversal === 'true';
            }
            
            renderCards();
            updateActiveCount();
            renderSetsList();
            updateStorageInfo();
            updateSignificatorDisplay();
        }

        function saveMasterCards() {
            try {
                localStorage.setItem('oracleCards', JSON.stringify(masterCards));
            } catch(e) {
                alert('ä¿å­˜å®¹é‡ã‚’è¶…ãˆã¾ã—ãŸã€‚ç”»åƒã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function saveSets() {
            localStorage.setItem('oracleSets', JSON.stringify(cardSets));
        }

        function getCurrentCards() {
            const cardIds = cardSets[currentSetName] || [];
            return cardIds.map(id => masterCards.find(c => c.id === id)).filter(Boolean);
        }

        function updateStorageInfo() {
            const storageInfo = document.getElementById('storage-info');
            const storageWarning = document.getElementById('storage-warning');
            if (!storageInfo || !storageWarning) return;
            
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length * 2;
                }
            }
            const mb = (total / 1024 / 1024).toFixed(2);
            storageInfo.textContent = `ä½¿ç”¨é‡: ${mb} MB`;
            
            if (total > 4 * 1024 * 1024) {
                storageWarning.style.display = 'block';
            } else {
                storageWarning.style.display = 'none';
            }
        }

        // ã‚·ã‚°ãƒ‹ãƒ•ã‚£ã‚±ãƒ¼ã‚¿ãƒ¼é–¢é€£
        function updateSignificatorDisplay() {
            const preview = document.getElementById('sig-preview');
            const toggleBox = document.getElementById('sig-toggle-box');
            const nameDisplay = document.getElementById('sig-name-display');
            
            // è¦ç´ ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (!preview || !toggleBox || !nameDisplay) return;
            
            if (significatorId !== null) {
                const card = masterCards.find(c => c.id === significatorId);
                if (card) {
                    if (card.imageData) {
                        preview.innerHTML = `<img src="${card.imageData}">`;
                    } else {
                        preview.innerHTML = card.name;
                    }
                    toggleBox.style.display = 'block';
                    nameDisplay.textContent = `(${card.name})`;
                } else {
                    significatorId = null;
                    preview.innerHTML = 'æœªè¨­å®š';
                    toggleBox.style.display = 'none';
                }
            } else {
                preview.innerHTML = 'æœªè¨­å®š';
                toggleBox.style.display = 'none';
            }
        }

        function openSignificatorSelect() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:10000;overflow:auto;padding:20px;';
            
            const activeCards = getCurrentCards();
            
            let cardList = '';
            activeCards.forEach(card => {
                const selected = card.id === significatorId ? 'border-color:rgba(255,200,100,0.8);background:rgba(255,200,100,0.2);' : '';
                const preview = card.imageData 
                    ? `<img src="${card.imageData}" style="width:100%;height:100%;object-fit:cover;">`
                    : card.name;
                cardList += `
                    <div onclick="selectSignificator(${card.id})" style="cursor:pointer;padding:10px;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.2);border-radius:8px;text-align:center;${selected}">
                        <div style="width:60px;height:90px;margin:0 auto 8px;background:#2a2a4a;border-radius:4px;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:10px;color:#888;">
                            ${preview}
                        </div>
                        <div style="font-size:12px;">${card.name}</div>
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div style="max-width:600px;margin:0 auto;background:rgba(15,32,39,0.98);padding:20px;border-radius:12px;border:2px solid rgba(255,200,100,0.5);">
                    <h2 style="color:#ffcc66;margin-bottom:15px;font-size:1.1em;">ã‚·ã‚°ãƒ‹ãƒ•ã‚£ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’é¸æŠ</h2>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;max-height:60vh;overflow-y:auto;">
                        ${cardList}
                    </div>
                    <div style="margin-top:15px;text-align:center;">
                        <button onclick="closeSignificatorModal()" class="btn" style="padding:12px 25px;">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            `;
            
            modal.id = 'sig-modal';
            document.body.appendChild(modal);
        }

        function selectSignificator(id) {
            significatorId = id;
            localStorage.setItem('oracleSignificator', id);
            updateSignificatorDisplay();
            closeSignificatorModal();
        }

        function clearSignificator() {
            significatorId = null;
            localStorage.removeItem('oracleSignificator');
            useSignificator = false;
            document.getElementById('use-sig-toggle').checked = false;
            updateSignificatorDisplay();
        }

        function closeSignificatorModal() {
            const modal = document.getElementById('sig-modal');
            if (modal) modal.remove();
        }

        function toggleSignificator() {
            useSignificator = document.getElementById('use-sig-toggle').checked;
        }

        function toggleReversal() {
            useReversal = document.getElementById('use-reversal-toggle').checked;
        }

        // ç”»åƒã‚’Base64ã«å¤‰æ›ï¼ˆãƒªã‚µã‚¤ã‚ºä»˜ãï¼‰
        function imageToBase64(file, maxSize, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let w = img.width;
                    let h = img.height;
                    
                    if (w > maxSize || h > maxSize) {
                        if (w > h) {
                            h = h * maxSize / w;
                            w = maxSize;
                        } else {
                            w = w * maxSize / h;
                            h = maxSize;
                        }
                    }
                    
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function selectBackImage(input) {
            const file = input.files[0];
            if (file) {
                imageToBase64(file, 300, function(data) {
                    backCardImage = data;
                    localStorage.setItem('oracleBackImage', backCardImage);
                    updateBackPreview();
                    updateStorageInfo();
                });
            }
        }
        
        function updateBackPreview() {
            const preview = document.getElementById('back-preview');
            if (!preview) return;
            if (backCardImage) {
                preview.innerHTML = `<img src="${backCardImage}">`;
            } else {
                preview.innerHTML = 'ğŸ”®';
            }
        }
        
        function setCardCount() {
            const count = parseInt(document.getElementById('card-count-input').value);
            if (count < 1 || count > 150) {
                alert('1ã€œ150æšã§è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            const currentCount = masterCards.length;
            if (count > currentCount) {
                for (let i = currentCount; i < count; i++) {
                    masterCards.push({
                        id: i,
                        name: `ã‚«ãƒ¼ãƒ‰ ${i + 1}`,
                        description: '',
                        imageData: ''
                    });
                }
            } else if (count < currentCount) {
                masterCards = masterCards.slice(0, count);
                Object.keys(cardSets).forEach(setName => {
                    cardSets[setName] = cardSets[setName].filter(id => id < count);
                });
            }
            
            saveMasterCards();
            saveSets();
            renderCards();
            updateActiveCount();
            updateStorageInfo();
        }
        
        function renderCards() {
            const grid = document.getElementById('card-grid');
            grid.innerHTML = '';
            
            masterCards.forEach((card, index) => {
                const item = document.createElement('div');
                item.className = 'card-item';
                
                const previewContent = card.imageData 
                    ? `<img src="${card.imageData}">`
                    : 'ç”»åƒãªã—';
                
                item.innerHTML = `
                    <div class="card-number">No.${index + 1}</div>
                    <div class="card-preview" id="preview-${index}">${previewContent}</div>
                    <input type="text" placeholder="åå‰" value="${card.name}" 
                           onchange="updateCardName(${index}, this.value)">
                    <textarea placeholder="èª¬æ˜" onchange="updateCardDesc(${index}, this.value)">${card.description}</textarea>
                    <input type="file" accept="image/*" style="display:none" 
                           id="file-${index}" onchange="selectImageFile(${index}, this)">
                    <button class="upload-btn" onclick="document.getElementById('file-${index}').click()">
                        ç”»åƒé¸æŠ
                    </button>
                `;
                grid.appendChild(item);
            });
        }
        
        function updateCardName(index, value) {
            masterCards[index].name = value;
            saveMasterCards();
        }
        
        function updateCardDesc(index, value) {
            masterCards[index].description = value;
            saveMasterCards();
        }
        
        function selectImageFile(index, input) {
            const file = input.files[0];
            if (file) {
                imageToBase64(file, 400, function(data) {
                    masterCards[index].imageData = data;
                    saveMasterCards();
                    
                    const preview = document.getElementById(`preview-${index}`);
                    preview.innerHTML = `<img src="${data}">`;
                    updateStorageInfo();
                });
            }
        }
        
        function updateActiveCount() {
            const count = getCurrentCards().length;
            document.getElementById('master-count').textContent = masterCards.length;
            document.getElementById('active-count').textContent = count;
            document.getElementById('spread-active-count').textContent = count;
        }
        
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${screen}-screen`).classList.add('active');
            event.target.classList.add('active');
            
            if (screen === 'spread') {
                updateActiveCount();
            } else if (screen === 'sets') {
                renderSetsList();
            } else if (screen === 'ritual') {
                loadCrystals();
            }
        }

        // ã‚»ãƒƒãƒˆç®¡ç†
        function createNewSet() {
            const setName = document.getElementById('new-set-name').value.trim();
            if (!setName) {
                alert('ã‚»ãƒƒãƒˆåã‚’å…¥åŠ›');
                return;
            }
            if (cardSets[setName]) {
                alert('æ—¢ã«å­˜åœ¨ã—ã¾ã™');
                return;
            }

            cardSets[setName] = [];
            saveSets();
            document.getElementById('new-set-name').value = '';
            renderSetsList();
        }

        function switchSet(setName) {
            if (!cardSets[setName]) return;
            currentSetName = setName;
            localStorage.setItem('oracleCurrentSet', currentSetName);
            updateActiveCount();
            renderSetsList();
        }

        function deleteSet(setName) {
            if (setName === 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ') {
                alert('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å‰Šé™¤ä¸å¯');
                return;
            }
            if (!confirm(`ã€Œ${setName}ã€ã‚’å‰Šé™¤?`)) return;
            
            delete cardSets[setName];
            if (currentSetName === setName) {
                switchSet('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ');
            }
            saveSets();
            renderSetsList();
        }

        function renderSetsList() {
            const list = document.getElementById('sets-list');
            list.innerHTML = '';
            document.getElementById('current-set-name').textContent = currentSetName;
            
            Object.keys(cardSets).forEach(setName => {
                const setCard = document.createElement('div');
                setCard.className = 'spread-card';
                if (setName === currentSetName) {
                    setCard.style.borderColor = 'rgba(100,200,255,0.8)';
                    setCard.style.background = 'rgba(100,200,255,0.2)';
                }
                
                const cardCount = cardSets[setName].length;
                
                let html = `<h3>${setName}</h3><p>${cardCount}æš</p>`;
                if (setName === currentSetName) {
                    html += `<p style="color:#64c8ff;font-size:12px;">âœ“ ä½¿ç”¨ä¸­</p>`;
                    html += `<button class="btn" style="padding:8px 12px;font-size:12px;margin-top:8px;" onclick="editSetCards()">ç·¨é›†</button>`;
                } else {
                    html += `<button class="btn" style="padding:8px 12px;font-size:12px;margin-top:8px;" onclick="switchSet('${setName}')">åˆ‡æ›¿</button>`;
                }
                
                if (setName !== 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ') {
                    html += `<button class="btn" style="padding:8px 12px;font-size:12px;margin-top:8px;background:rgba(220,53,69,0.5);border-color:#dc3545;" onclick="deleteSet('${setName}')">å‰Šé™¤</button>`;
                }
                
                setCard.innerHTML = html;
                list.appendChild(setCard);
            });
        }

        function editSetCards() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:10000;overflow:auto;padding:20px;';
            
            const currentCardIds = cardSets[currentSetName] || [];
            
            let checkboxes = '';
            masterCards.forEach(card => {
                const checked = currentCardIds.includes(card.id) ? 'checked' : '';
                checkboxes += `
                    <label style="display:flex;align-items:center;padding:10px;background:rgba(255,255,255,0.05);margin:5px 0;border-radius:4px;">
                        <input type="checkbox" value="${card.id}" ${checked} style="margin-right:10px;width:20px;height:20px;">
                        <span style="font-size:14px;">No.${card.id + 1}: ${card.name}</span>
                    </label>
                `;
            });
            
            modal.innerHTML = `
                <div style="max-width:600px;margin:0 auto;background:rgba(15,32,39,0.98);padding:20px;border-radius:12px;border:2px solid rgba(100,200,255,0.5);">
                    <h2 style="color:#64c8ff;margin-bottom:15px;font-size:1.1em;">ã€Œ${currentSetName}ã€ã‚’ç·¨é›†</h2>
                    <div style="margin-bottom:15px;">
                        <button onclick="selectAllCards(true)" class="btn" style="padding:8px 15px;font-size:12px;margin:3px;">å…¨é¸æŠ</button>
                        <button onclick="selectAllCards(false)" class="btn" style="padding:8px 15px;font-size:12px;margin:3px;">å…¨è§£é™¤</button>
                    </div>
                    <div id="card-checkboxes" style="max-height:50vh;overflow-y:auto;">${checkboxes}</div>
                    <div style="margin-top:15px;text-align:center;">
                        <button onclick="saveSetCards()" class="btn" style="padding:12px 25px;margin:5px;">ä¿å­˜</button>
                        <button onclick="closeSetModal()" class="btn" style="padding:12px 25px;margin:5px;background:rgba(220,53,69,0.5);border-color:#dc3545;">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            `;
            
            modal.id = 'set-modal';
            document.body.appendChild(modal);
        }

        function selectAllCards(select) {
            document.querySelectorAll('#card-checkboxes input').forEach(cb => cb.checked = select);
        }

        function saveSetCards() {
            const checked = document.querySelectorAll('#card-checkboxes input:checked');
            const ids = Array.from(checked).map(cb => parseInt(cb.value));
            
            if (ids.length < 1) {
                alert('æœ€ä½1æšé¸æŠ');
                return;
            }
            
            cardSets[currentSetName] = ids;
            saveSets();
            updateActiveCount();
            renderSetsList();
            closeSetModal();
        }

        function closeSetModal() {
            const modal = document.getElementById('set-modal');
            if (modal) modal.remove();
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰
        function selectSpread(type, size) {
            const activeCards = getCurrentCards();
            const errorContainer = document.getElementById('error-container');
            
            if (activeCards.length < size) {
                errorContainer.innerHTML = `<div class="error-message">${size}æšå¿…è¦ã§ã™ï¼ˆç¾åœ¨${activeCards.length}æšï¼‰</div>`;
                return;
            }
            
            errorContainer.innerHTML = '';
            currentSpread = type;
            currentSpreadSize = size;
            
            showScreen('reading');
            document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
            document.querySelector('.nav-tabs button:nth-child(4)').classList.add('active');
            setupSpread(type, size);
        }
        
        function setupSpread(type, size) {
            const inner = document.getElementById('spread-inner');
            inner.innerHTML = '';
            document.getElementById('result-info').style.display = 'none';
            
            const positions = getSpreadPositions(type, size);
            
            positions.forEach((pos, i) => {
                const slot = document.createElement('div');
                slot.className = 'card-slot';
                slot.style.left = pos.x + 'px';
                slot.style.top = pos.y + 'px';
                slot.id = `slot-${i}`;
                slot.innerHTML = `<span>${pos.label || (i + 1)}</span>`;
                inner.appendChild(slot);
            });
        }
        
        function getSpreadPositions(type, size) {
            const positions = [];
            const isMobile = window.innerWidth < 768;
            // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å·¦ã«ä½™ç™½ã‚’ç¢ºä¿
            const offsetX = isMobile ? 50 : 0;
            const cx = 250 + offsetX;
            const cy = 200;
            
            switch(type) {
                case 'one':
                    positions.push({x: cx, y: cy, label: 'ç­”'});
                    break;
                case 'two':
                    positions.push({x: cx - 70, y: cy, label: 'A'});
                    positions.push({x: cx + 70, y: cy, label: 'B'});
                    break;
                case 'three':
                    positions.push({x: cx - 120, y: cy, label: 'éå»'});
                    positions.push({x: cx, y: cy, label: 'ç¾åœ¨'});
                    positions.push({x: cx + 120, y: cy, label: 'æœªæ¥'});
                    break;
                case 'neutralize':
                    // 5æšæ¨ªä¸¦ã³ - ãƒ¢ãƒã‚¤ãƒ«ã§ã¯é–“éš”ã‚’ç‹­ã‚ã‚‹
                    const nGap = isMobile ? 70 : 100;
                    positions.push({x: cx - nGap*2, y: cy, label: 'ç¾çŠ¶'});
                    positions.push({x: cx - nGap, y: cy, label: 'åˆºæ¿€'});
                    positions.push({x: cx, y: cy, label: 'é€ƒé¿'});
                    positions.push({x: cx + nGap, y: cy, label: 'å­¤ç«‹'});
                    positions.push({x: cx + nGap*2, y: cy, label: 'çµæ™¶'});
                    break;
                case 'circle':
                    // 8å±æ€§ã‚’å††å½¢ã«é…ç½®
                    const attrs = ['èœ˜è››', 'è¶', 'èŠ±', 'èš•', 'ç‹', 'è¡€', 'æœˆ', 'é¢¨'];
                    const radius = isMobile ? 100 : 140;
                    for (let i = 0; i < 8; i++) {
                        const angle = (i * 45 - 90) * Math.PI / 180;
                        positions.push({
                            x: cx + Math.cos(angle) * radius,
                            y: cy + Math.sin(angle) * radius,
                            label: attrs[i]
                        });
                    }
                    // ä¸­å¤®ã«çµæ™¶
                    positions.push({x: cx, y: cy, label: 'ğŸ’'});
                    break;
                case 'hexagram':
                    const hGap = isMobile ? 80 : 120;
                    positions.push({x: cx - hGap, y: cy - 80, label: 'éå»'});
                    positions.push({x: cx, y: cy - 80, label: 'ç¾åœ¨'});
                    positions.push({x: cx + hGap, y: cy - 80, label: 'æœªæ¥'});
                    positions.push({x: cx - hGap, y: cy + 80, label: 'å¯¾ç­–'});
                    positions.push({x: cx, y: cy + 80, label: 'å‘¨å›²'});
                    positions.push({x: cx + hGap, y: cy + 80, label: 'çµæœ'});
                    break;
                case 'celtic':
                    const cGap = isMobile ? 80 : 120;
                    positions.push({x: cx, y: cy, label: '1'});
                    positions.push({x: cx, y: cy, label: '2'});
                    positions.push({x: cx, y: cy - 100, label: '3'});
                    positions.push({x: cx, y: cy + 100, label: '4'});
                    positions.push({x: cx - cGap, y: cy, label: '5'});
                    positions.push({x: cx + cGap, y: cy, label: '6'});
                    positions.push({x: cx + cGap + 80, y: cy + 120, label: '7'});
                    positions.push({x: cx + cGap + 80, y: cy + 40, label: '8'});
                    positions.push({x: cx + cGap + 80, y: cy - 40, label: '9'});
                    positions.push({x: cx + cGap + 80, y: cy - 120, label: '10'});
                    break;
                case 'nine':
                    const nineGap = isMobile ? 80 : 120;
                    for (let r = 0; r < 3; r++) {
                        for (let c = 0; c < 3; c++) {
                            positions.push({x: cx - nineGap + c * nineGap, y: cy - 100 + r * 100, label: r * 3 + c + 1});
                        }
                    }
                    break;
                case 'grand':
                    const gCardW = isMobile ? 55 : 75;
                    const gCardH = isMobile ? 85 : 115;
                    const gStartX = isMobile ? 40 : 50;
                    for (let r = 0; r < 4; r++) {
                        for (let c = 0; c < 9; c++) {
                            positions.push({x: gStartX + c * gCardW, y: 30 + r * gCardH, label: r * 9 + c + 1});
                        }
                    }
                    break;
            }
            return positions;
        }
        
        function shuffleAndDraw() {
            const activeCards = getCurrentCards();
            const sigCard = significatorId !== null ? masterCards.find(c => c.id === significatorId) : null;
            const isFixedSig = useSignificator && sigCard && ['one', 'two', 'neutralize', 'circle'].includes(currentSpread);
            const isShuffleSig = useSignificator && sigCard && currentSpread === 'grand';
            
            let shufflePool = activeCards;
            if (isFixedSig) {
                shufflePool = activeCards.filter(c => c.id !== significatorId);
            }
            
            const requiredCount = isFixedSig ? currentSpreadSize - 1 : currentSpreadSize;
            if (shufflePool.length < requiredCount) {
                alert('ã‚«ãƒ¼ãƒ‰ä¸è¶³');
                return;
            }
            
            const inner = document.getElementById('spread-inner');
            inner.innerHTML = '';
            inner.style.minHeight = '350px';
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ
            const shuffleArea = document.createElement('div');
            shuffleArea.id = 'shuffle-area';
            shuffleArea.style.cssText = 'position:relative;width:100%;height:350px;touch-action:none;';
            inner.appendChild(shuffleArea);
            
            // ã‚«ãƒ¼ãƒ‰ã®å±±ï¼ˆãƒªãƒ•ãƒ«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
            const deckX = shuffleArea.offsetWidth / 2 || 150;
            const deckY = 150;
            
            const shuffleCards = [];
            const cardCount = Math.min(12, shufflePool.length);
            
            for (let i = 0; i < cardCount; i++) {
                const card = document.createElement('div');
                card.className = 'shuffle-card';
                card.style.cssText = `
                    position:absolute;
                    width:60px;height:90px;
                    background:linear-gradient(135deg,#667eea,#764ba2);
                    border-radius:6px;
                    box-shadow:0 2px 8px rgba(0,0,0,0.4);
                    left:${deckX - 30}px;
                    top:${deckY - 45 - i * 2}px;
                    z-index:${20 + i};
                    transition:all 0.3s ease;
                    cursor:pointer;
                    display:flex;align-items:center;justify-content:center;
                `;
                if (backCardImage) {
                    card.innerHTML = `<img src="${backCardImage}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">`;
                } else {
                    card.innerHTML = 'ğŸ”®';
                    card.style.fontSize = '24px';
                }
                card.dataset.collected = 'false';
                shuffleCards.push(card);
                shuffleArea.appendChild(card);
            }
            
            // ãƒªãƒ•ãƒ«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(() => {
                shuffleCards.forEach((card, i) => {
                    const delay = i * 50;
                    setTimeout(() => {
                        card.style.transform = 'translateY(-40px) rotateX(-20deg)';
                        setTimeout(() => {
                            card.style.transform = 'translateY(0) rotateX(0)';
                        }, 150);
                    }, delay);
                });
            }, 200);
            
            // æ•£ã‚‰ã°ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(() => {
                shuffleCards.forEach((card, i) => {
                    const angle = (i / cardCount) * Math.PI * 2 + Math.random() * 0.5;
                    const dist = 80 + Math.random() * 60;
                    const x = deckX - 30 + Math.cos(angle) * dist;
                    const y = deckY - 45 + Math.sin(angle) * dist;
                    const rot = (Math.random() - 0.5) * 40;
                    
                    card.style.left = x + 'px';
                    card.style.top = y + 'px';
                    card.style.transform = `rotate(${rot}deg)`;
                    card.style.zIndex = 10 + i;
                });
                
                // èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ
                const hint = document.createElement('div');
                hint.id = 'collect-hint';
                hint.style.cssText = 'text-align:center;color:#64c8ff;font-size:14px;margin-top:10px;position:absolute;bottom:10px;width:100%;';
                hint.innerHTML = 'â†“ ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é›†ã‚ã¦ãã ã•ã„ â†“';
                shuffleArea.appendChild(hint);
                
                // ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã§ã‚«ãƒ¼ãƒ‰ã‚’é›†ã‚ã‚‹
                let collectedCount = 0;
                shuffleCards.forEach((card, i) => {
                    card.onclick = () => {
                        if (card.dataset.collected === 'true') return;
                        card.dataset.collected = 'true';
                        collectedCount++;
                        
                        // ä¸­å¤®ã«æˆ»ã™
                        card.style.left = (deckX - 30) + 'px';
                        card.style.top = (deckY - 45 - collectedCount * 2) + 'px';
                        card.style.transform = 'rotate(0deg)';
                        card.style.zIndex = 30 + collectedCount;
                        
                        // å…¨éƒ¨é›†ã¾ã£ãŸã‚‰ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
                        if (collectedCount >= cardCount) {
                            setTimeout(() => finishShuffle(), 500);
                        }
                    };
                });
                
                // ã¾ã¨ã‚ã¦é›†ã‚ã‚‹ãƒœã‚¿ãƒ³
                const collectAllBtn = document.createElement('button');
                collectAllBtn.className = 'btn';
                collectAllBtn.style.cssText = 'position:absolute;bottom:40px;left:50%;transform:translateX(-50%);padding:8px 20px;font-size:13px;';
                collectAllBtn.textContent = 'ã¾ã¨ã‚ã¦é›†ã‚ã‚‹';
                collectAllBtn.onclick = () => {
                    shuffleCards.forEach((card, i) => {
                        if (card.dataset.collected === 'false') {
                            setTimeout(() => {
                                card.dataset.collected = 'true';
                                collectedCount++;
                                card.style.left = (deckX - 30) + 'px';
                                card.style.top = (deckY - 45 - collectedCount * 2) + 'px';
                                card.style.transform = 'rotate(0deg)';
                                card.style.zIndex = 30 + collectedCount;
                                
                                if (collectedCount >= cardCount) {
                                    setTimeout(() => finishShuffle(), 500);
                                }
                            }, i * 100);
                        }
                    });
                };
                shuffleArea.appendChild(collectAllBtn);
                
            }, 1500);
            
            // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãå‡¦ç†
            function finishShuffle() {
                const shuffled = [...shufflePool].sort(() => Math.random() - 0.5);
                
                if (isFixedSig) {
                    drawnCards = [];
                    const sigPosition = getSignificatorPosition(currentSpread);
                    let shuffleIndex = 0;
                    
                    for (let i = 0; i < currentSpreadSize; i++) {
                        if (i === sigPosition) {
                            drawnCards.push({...sigCard, isReversed: false, isSignificator: true});
                        } else {
                            drawnCards.push({
                                ...shuffled[shuffleIndex],
                                isReversed: useReversal ? Math.random() < 0.5 : false,
                                isSignificator: false
                            });
                            shuffleIndex++;
                        }
                    }
                } else {
                    drawnCards = shuffled.slice(0, currentSpreadSize).map(card => ({
                        ...card,
                        isReversed: useReversal ? Math.random() < 0.5 : false,
                        isSignificator: isShuffleSig && card.id === significatorId
                    }));
                }
                
                // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                shuffleArea.style.transition = 'opacity 0.3s';
                shuffleArea.style.opacity = '0';
                
                setTimeout(() => {
                    shuffleArea.remove();
                    inner.style.minHeight = '';
                    setupSpread(currentSpread, currentSpreadSize);
                    
                    drawnCards.forEach((card, i) => {
                        setTimeout(() => drawCard(i, card, false), i * 400);
                    });
                    
                    setTimeout(showResults, drawnCards.length * 400 + 800);
                }, 300);
            }
        }
        
        function getSignificatorPosition(spread) {
            switch(spread) {
                case 'one': return 0; // å®Ÿéš›ã¯è„‡ã«ç½®ããŒã€è¡¨ç¤ºä¸Šã¯0
                case 'two': return 0; // å·¦
                case 'neutralize': return -1; // ç‰¹æ®Šå‡¦ç†ï¼ˆä¸Šéƒ¨ã«é…ç½®ï¼‰
                case 'circle': return 8; // ä¸­å¤®
                default: return 0;
            }
        }
        
        function skipShuffle() {
            const activeCards = getCurrentCards();
            const sigCard = significatorId !== null ? masterCards.find(c => c.id === significatorId) : null;
            const isFixedSig = useSignificator && sigCard && ['one', 'two', 'neutralize', 'circle'].includes(currentSpread);
            const isShuffleSig = useSignificator && sigCard && currentSpread === 'grand';
            
            let shufflePool = activeCards;
            if (isFixedSig) {
                shufflePool = activeCards.filter(c => c.id !== significatorId);
            }
            
            const requiredCount = isFixedSig ? currentSpreadSize - 1 : currentSpreadSize;
            if (shufflePool.length < requiredCount) {
                alert('ã‚«ãƒ¼ãƒ‰ä¸è¶³');
                return;
            }
            
            const shuffled = [...shufflePool].sort(() => Math.random() - 0.5);
            
            if (isFixedSig) {
                drawnCards = [];
                const sigPosition = getSignificatorPosition(currentSpread);
                let shuffleIndex = 0;
                
                for (let i = 0; i < currentSpreadSize; i++) {
                    if (i === sigPosition) {
                        drawnCards.push({...sigCard, isReversed: false, isSignificator: true});
                    } else {
                        drawnCards.push({
                            ...shuffled[shuffleIndex],
                            isReversed: useReversal ? Math.random() < 0.5 : false,
                            isSignificator: false
                        });
                        shuffleIndex++;
                    }
                }
            } else {
                drawnCards = shuffled.slice(0, currentSpreadSize).map(card => ({
                    ...card,
                    isReversed: useReversal ? Math.random() < 0.5 : false,
                    isSignificator: isShuffleSig && card.id === significatorId
                }));
            }
            
            drawnCards.forEach((card, i) => drawCard(i, card, true));
            showResults();
        }
        
        function drawCard(index, card, instant) {
            const slot = document.getElementById(`slot-${index}`);
            if (!slot) return;
            
            slot.classList.add('filled');
            if (card.isSignificator) {
                slot.style.boxShadow = '0 0 15px rgba(255,200,100,0.8)';
                slot.style.borderColor = 'rgba(255,200,100,0.8)';
            }
            slot.innerHTML = '';
            
            const cardInner = document.createElement('div');
            cardInner.className = 'card-inner';
            
            const cardBack = document.createElement('div');
            cardBack.className = 'card-face card-back';
            if (backCardImage) {
                cardBack.innerHTML = `<img src="${backCardImage}">`;
            } else {
                cardBack.innerHTML = 'ğŸ”®';
            }
            
            const cardFront = document.createElement('div');
            cardFront.className = 'card-face card-front';
            if (card.isReversed) cardFront.classList.add('reversed');
            
            if (card.imageData) {
                const img = document.createElement('img');
                img.src = card.imageData;
                cardFront.appendChild(img);
            } else {
                cardFront.innerHTML = `<div class="card-text">${card.name}</div>`;
            }
            
            cardFront.onclick = function(e) {
                e.stopPropagation();
                if (card.imageData) {
                    openImageModal(card.imageData, card.isReversed);
                }
            };
            
            cardInner.appendChild(cardBack);
            cardInner.appendChild(cardFront);
            slot.appendChild(cardInner);
            
            if (instant) {
                cardInner.classList.add('flipped');
            } else {
                setTimeout(() => cardInner.classList.add('flipped'), 200);
            }
        }
        
        function openImageModal(src, reversed) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            img.src = src;
            img.className = 'modal-image' + (reversed ? ' reversed' : '');
            modal.classList.add('show');
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('show');
        }
        
        function showResults() {
            const resultDiv = document.getElementById('result-info');
            resultDiv.style.display = 'block';
            
            let html = '<h3>çµæœ</h3>';
            
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰åˆ¥ã®ã‚¬ã‚¤ãƒ‰
            if (currentSpread === 'neutralize') {
                html += `<div style="background:rgba(100,200,255,0.1);padding:12px;border-radius:8px;margin-bottom:15px;font-size:13px;">
                    <strong style="color:#64c8ff;">èª­ã¿æ–¹</strong><br>
                    1. ã¾ãš1â†’5ã‚’æµã‚Œã¨ã—ã¦èª­ã‚€<br>
                    2. åˆºæ¿€/é€ƒé¿/å­¤ç«‹ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ç‚¹æ¤œ<br>
                    3. çµæ™¶ã‚’ã€Œä»Šæ—¥ã®çµè«–ã€ã¨ã—ã¦ä¸€è¨€ã§
                </div>`;
            } else if (currentSpread === 'circle') {
                html += `<div style="background:rgba(100,200,255,0.1);padding:12px;border-radius:8px;margin-bottom:15px;font-size:13px;">
                    <strong style="color:#64c8ff;">èª­ã¿æ–¹</strong><br>
                    8å±æ€§ã®ã©ã“ãŒå¼·ãå‡ºã¦ã„ã‚‹ã‹ç¢ºèª<br>
                    ä¸­å¤®ã®ğŸ’ã¯å…¨ä½“ã‚’ä¸­ç«‹åŒ–ã—ã¦æ®‹ã™æ ¸
                </div>`;
            } else if (currentSpread === 'grand' && useSignificator) {
                const sigIndex = drawnCards.findIndex(c => c.isSignificator);
                if (sigIndex !== -1) {
                    html += `<div style="background:rgba(255,200,100,0.1);padding:12px;border-radius:8px;margin-bottom:15px;font-size:13px;border:1px solid rgba(255,200,100,0.5);">
                        <strong style="color:#ffcc66;">ã‚·ã‚°ãƒ‹ãƒ•ã‚£ã‚±ãƒ¼ã‚¿ãƒ¼ä½ç½®: ${sigIndex + 1}ç•ª</strong><br>
                        ã‚°ãƒ©ãƒ³ã‚¿ãƒ–ãƒ­ãƒ¼å†…ã§ã®ã€Œç§ã€ã®ä½ç½®
                    </div>`;
                }
            }
            
            drawnCards.forEach((card, i) => {
                const pos = card.isReversed ? 'é€†' : 'æ­£';
                const positions = getSpreadPositions(currentSpread, currentSpreadSize);
                const label = positions[i] ? positions[i].label : (i + 1);
                const sigStyle = card.isSignificator ? 'border-left:3px solid rgba(255,200,100,0.8);' : '';
                const sigBadge = card.isSignificator ? '<span style="background:rgba(255,200,100,0.3);padding:2px 6px;border-radius:4px;font-size:11px;margin-left:5px;">ã‚·ã‚°ãƒ‹ãƒ•ã‚£ã‚±ãƒ¼ã‚¿ãƒ¼</span>' : '';
                html += `<div class="card-meaning" style="${sigStyle}"><strong>${label}: ${card.name} (${pos})${sigBadge}</strong><br>${card.description || 'èª¬æ˜ãªã—'}</div>`;
            });
            
            resultDiv.innerHTML = html;
        }
        
        function resetReading() {
            drawnCards = [];
            if (currentSpread && currentSpreadSize) {
                setupSpread(currentSpread, currentSpreadSize);
            }
        }
        
        // å„€å¼
        let breathCount = 0;
        
        function startBreathing() {
            breathCount = 0;
            const display = document.getElementById('breathTimer');
            const btn = document.getElementById('breathBtn');
            btn.disabled = true;
            
            function cycle() {
                if (breathCount >= 3) {
                    display.textContent = 'æº–å‚™å®Œäº† âœ¨';
                    btn.disabled = false;
                    return;
                }
                breathCount++;
                display.textContent = `${breathCount}å›ç›®: å¸ã£ã¦...`;
                setTimeout(() => {
                    display.textContent = `${breathCount}å›ç›®: åã„ã¦...`;
                    setTimeout(cycle, 4000);
                }, 4000);
            }
            cycle();
        }
        
        function setQuestion(text) {
            document.getElementById('questionInput').value = text;
        }
        
        function goToSpread() {
            const q = document.getElementById('questionInput').value;
            if (q) localStorage.setItem('oracleQuestion', q);
            showScreen('spread');
            document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
            document.querySelector('.nav-tabs button:nth-child(3)').classList.add('active');
        }
        
        function saveCrystal() {
            const note = document.getElementById('crystalNote').value.trim();
            if (!note) {
                alert('è¨€è‘‰ã‚’å…¥åŠ›');
                return;
            }
            
            const crystals = JSON.parse(localStorage.getItem('oracleCrystals') || '[]');
            crystals.unshift({date: new Date().toLocaleDateString('ja-JP'), text: note});
            if (crystals.length > 20) crystals.pop();
            
            localStorage.setItem('oracleCrystals', JSON.stringify(crystals));
            document.getElementById('crystalNote').value = '';
            loadCrystals();
            alert('ä¿å­˜ã—ã¾ã—ãŸ âœ¨');
        }
        
        function loadCrystals() {
            const crystals = JSON.parse(localStorage.getItem('oracleCrystals') || '[]');
            const list = document.getElementById('crystalList');
            
            if (crystals.length === 0) {
                list.innerHTML = '<p style="color:#888;font-size:13px;">ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            list.innerHTML = crystals.map(c => `
                <div class="crystal-item">
                    <div class="crystal-date">${c.date}</div>
                    <div style="font-size:14px;line-height:1.5;">${c.text}</div>
                </div>
            `).join('');
        }
        
        // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã‹ã‚‰é–‹å§‹
        function startApp() {
            console.log('startApp called');
            const title = document.getElementById('titleScreen');
            if (title) {
                title.style.transition = 'opacity 0.5s';
                title.style.opacity = '0';
                setTimeout(() => {
                    title.classList.add('hidden');
                }, 500);
            }
        }
        
        // åˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚titleScreenã¯å‹•ãã‚ˆã†ã«ï¼‰
        try {
            init();
        } catch(e) {
            console.error('init error:', e);
        }
        try {
            loadCrystals();
        } catch(e) {
            console.error('loadCrystals error:', e);
        }
        
        // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ãƒœã‚¿ãƒ³ï¼ˆDOMContentLoadedå¾Œã«è¨­å®šï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            var btn = document.getElementById('startBtn');
            if (btn) {
                btn.addEventListener('click', startApp);
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    startApp();
                });
            }
        });
        
        // å³æ™‚å®Ÿè¡Œç‰ˆã‚‚å¿µã®ãŸã‚
        (function() {
            var btn = document.getElementById('startBtn');
            if (btn) {
                btn.onclick = startApp;
            }
        })();
        
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportData() {
            const data = {
                version: 1,
                exportDate: new Date().toISOString(),
                masterCards: masterCards,
                cardSets: cardSets,
                currentSetName: currentSetName,
                backCardImage: backCardImage,
                significatorId: significatorId,
                crystals: JSON.parse(localStorage.getItem('oracleCrystals') || '[]')
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mayumayan-oracle-backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†ï¼\nãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒãƒ›ã«é€ã£ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„');
        }
        
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.masterCards || !data.cardSets) {
                        alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
                        return;
                    }
                    
                    if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
                        return;
                    }
                    
                    masterCards = data.masterCards;
                    cardSets = data.cardSets;
                    currentSetName = data.currentSetName || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ';
                    backCardImage = data.backCardImage || '';
                    significatorId = data.significatorId !== undefined ? data.significatorId : null;
                    
                    saveMasterCards();
                    saveSets();
                    localStorage.setItem('oracleCurrentSet', currentSetName);
                    if (backCardImage) {
                        localStorage.setItem('oracleBackImage', backCardImage);
                    }
                    if (significatorId !== null) {
                        localStorage.setItem('oracleSignificator', significatorId);
                    } else {
                        localStorage.removeItem('oracleSignificator');
                    }
                    if (data.crystals) {
                        localStorage.setItem('oracleCrystals', JSON.stringify(data.crystals));
                    }
                    
                    renderCards();
                    updateActiveCount();
                    updateBackPreview();
                    updateStorageInfo();
                    updateSignificatorDisplay();
                    
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼');
                } catch(err) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }
    </script>
</body>
</html>
